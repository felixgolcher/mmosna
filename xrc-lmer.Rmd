---
title: "Exercise for Linear General Mixed Models"
author: "Felix Golcher"
date: "`r format(Sys.time(), '%d %B, %Y %H:%M')`"
bibliography: [packages.bib]
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_depth: 6
    number_sections: true
    fig_caption: yes
    table_caption: yes
    df_print: "paged"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE,
                      autodep = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.width = (myfw <- 7),
                      fig.height = myfw/2)
knitr::write_bib(file = 'packages.bib')
inputpath <- "data/"
outputpath <- inputpath

# options(contrasts = c(unordered = "contr.sum",
#                           ordered= "contr.poly"))


```

```{r packages, include=FALSE, cache=FALSE}
library(readxl)
library(gridExtra)
# library(ggrepel)
library(tidyverse)
# library(ggplot2)
# library(emmeans)
library(Hmisc)
library(scales)
library(qqplotr)
library(lme4)
# library(optimx)
# library(nloptr)
library(effects)
# library(papaja)
library(sjPlot)
library(sjlabelled)
library(kableExtra)
library(knitr)
knit_hooks$set(inline =
  function (x) {
      if (is.numeric(x)) {
          x = round(x, getOption("digits"))
          if (x < 1 & x > -1) {
            x = sub("0\\.","\\.",as.character(x)) 
          }

      }
      paste(as.character(x), collapse = ", ")
      }
  )
write_bib(x = .packages(), file="packages.bib")
theme_set(theme_minimal())

## set som defaults
tab_model <- function(...){
  sjPlot::tab_model(collapse.ci = T,
                    linebreak = T,
                    digits.p = 3, # not smaller, since bug https://github.com/strengejacke/sjPlot/issues/789
                    show.intercept = F,
                    p.style = "numeric", # numeric seems broken.
                    show.icc = F,
                    show.obs = F,
                    show.ngroups = F,
                    ci.hyphen = ",",
                    ...)
}
```


# Prep

```{r}
maindata <- read_excel("data/LengthInWords.xlsx")
metadata <- read_excel("data/LengthInWords-meta.xlsx")
fulldata <- full_join(maindata, metadata)
stopifnot(nrow(fulldata) == nrow(maindata))
stopifnot(ncol(fulldata) == ncol(maindata) + ncol(metadata) -1)
```


# Complexity


## Words

The data don't look very normally distributed:

```{r, echo=FALSE}
fulldata %>% 
  ggplot(aes(Situation, Words#, col=Question
             ))+
  #geom_violin()+
  geom_boxplot()+
  geom_jitter(width = .01)+
  scale_y_sqrt()
```

```{r, include=FALSE}
fulldata %>% 
    group_by(Situation) %>% 
    mutate(Words = scale(Words)) %>% 
    ungroup() %>% 
   ggplot(aes(sample=Words))+
   geom_qq_line()+
   geom_qq()->gg7
```

When we try some standard transformation the $\sqrt{~~}$-Transformation is a clear winner:


```{r, fig.cap="Square root transformed data show pretty normally distributed.", echo=FALSE}
grid.arrange(gg7 + ggtitle("untransformed"),
             (gg7 +
               ggtitle("log transformed")) %+% 
               (fulldata %>% 
                  mutate(Words = log(Words)) %>% 
                  group_by(Situation) %>% 
                  mutate(Words = scale(Words)) %>% 
                  ungroup()),
             (gg7 +
               ggtitle("sqrt transformed")) %+% 
               (fulldata %>% 
                  mutate(Words = sqrt(Words)) %>% 
                  group_by(Situation) %>% 
                  mutate(Words = scale(Words)) %>% 
                  ungroup()),
             (gg7 +
               ggtitle("reverse transformed")) %+% 
               (fulldata %>% 
                  mutate(Words = -1/(Words)) %>% 
                  group_by(Situation) %>% 
                  mutate(Words = scale(Words)) %>% 
                  ungroup()),
             nrow = 2)
```

We did not look at residuals so far, which is what actually has to be normally distributed. But we got a glance that gave us a very good candidate.

```{r}
w0 <- lmer(sqrt(Words) ~ Abi + Situation + (1|TN_ID), data=fulldata)
summary(w0)
```


```{r, echo=FALSE, fig.cap="The Residuals look quite nice"}
data.frame(resid = resid(w0)) %>% 
  ggplot(aes(sample = scale(resid))) + ## qqband wants that... 
  geom_qq_band() +
  geom_qq()+
  geom_qq_line()
```


```{r}
drop1(update(w0, REML = F), test = "Chisq")
```

```{r}
plot(allEffects(w0)[c(1,2)])
```

```{r}
tab_model(w0)
```


```{r}
Sit <- c(
  A="E-Mail/pupil",
  C="E-Mail/L2 student",
  B="Exam task",
  D="Tutorial task")
sitseq <- c("A","C","B","D")

cm <- as.matrix(cbind(
  # offset
  1/4,
  # A vs B
  c(1,-1,0,0),
  # C vs D
  c(0,0,1,-1),
  # AB vd CD
  c(1/2, 1/2, -1/2, -1/2)))
cmm <- solve(t(cm))
cmn <- cmm[,-1]
colnames(cmn) <- paste0(": ",
                        c(paste(Sit[c(1,3)], "-", Sit[c(2,4)]),
                          "Email vs Exam/Tutorial"))
fulldata %>% 
  mutate(Situation = factor(Situation, levels = Sit),
         Situation = C(Situation, contr = cmn)) -> contrdata
```

```{r}
w1 <- update(w0, data = contrdata)
```

```{r}
tab_model(w1)
```

```{r}
plot(allEffects(w1)[c(1,2)])
```


## packages

`r paste0("@R-",setdiff(.packages(), c("datasets","grDevices", "graphics", "methods", "stats", "utils")), collapse = ", ")`

# References